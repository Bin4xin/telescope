name: install test

on: [workflow_dispatch]
#on:
#  push:
#    branches:
#      - main

jobs:
  install:
    runs-on: ubuntu-latest
    env:
      LSI: 'true'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: depend cache
        id: cache
        uses: actions/cache@v2
        env:
          CACHE_ID: 1
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-depend-${{ env.CACHE_ID }}-${{ hashFiles('requirement.txt') }}
          restore-keys: |
            ${{ runner.os }}-bundler-${{ env.CACHE_ID }}-

      - name: download and install
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "maybe there are some cache i found!"
      - name: first to domain int
        run: |
          echo "here is function to detected domain from brupdns.py."
      - name: sencond to scan domains ports
        run: |
          echo "ready to scan."
          #tar -zxvf nmap_bin.tar.gz
          #ls -la
          #ls -la nmap_bin
          #cd nmap_bin && chmod +x script.sh && ./script.sh nmap -V
          #./script.sh nmap -p- -v -sV -T4 -A 47.74.31.64
      - name: thirdly to run aq-bin screenshots
        run: |
          echo "test chrome bin files."
          chmod +x 7zzs && ./7zzs x chrome-linux.7z &>/dev/null
          #tar -zxvf chrome-linux.tar.gz
          ls -la chrome-linux
          chmod +x chrome-linux/chrome && file chrome-linux/chrome
          domain=sentrylab.cn && cat $domain-output.xml | ./aquatone/aquatone -chrome-path chrome-linux/chrome -nmap -out $domain-html-output && tar -czf attachments.tar.gz $domain-html-output
          echo "扫描完成，这里是附件" > result.html
      - name: debug some bin files
        run: |
          echo "success!"
          #bash ./entrypoint.sh sentrylab.cn
      - name: 'Send mail'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.yandex.com
          server_port: 465
          #username: ${{ secrets.MAIL_USERNAME }}
          #password: ${{ secrets.MAIL_PASSWORD }}
          username: ${{secrets.SENTRY_MAIL_USERNAME}}
          password: ${{secrets.SENTRY_MAIL_PASSWORD}}
          subject: "您的订阅信息"
          html_body: file://result.html
          to: bin4xin.sentrylab@qq.com
          #cc: chihou.pro@gmail.com
          #from: 哨兵 -  ${{ env.REPORT_COMMIT }}
          from: 哨兵
          content_type: text/html
          attachments: attachments.tar.gz